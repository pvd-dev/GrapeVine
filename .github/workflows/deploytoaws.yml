name: Build and deploy Docker app to Lightsail
on:
  push:
    branches:
      - master
env:
  AWS_REGION: eu-central-1
  AWS_LIGHTSAIL_SERVICE_NAME: franklyapp
jobs:
  deploy:
    name: Build and deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install Utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip
      - name: Install AWS Client
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install || true
          aws --version
          curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl" -o "lightsailctl"
          sudo mv "lightsailctl" "/usr/local/bin/lightsailctl"
          sudo chmod +x /usr/local/bin/lightsailctl
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: Setting all the secrets
        run: wget https://franklyappsecret.s3.eu-central-1.amazonaws.com/Env_Settings.cfg?response-content-disposition=inline&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEPn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCWV1LXdlc3QtMiJHMEUCIQC5EVdk3v1AMtcWfBTcd%2BOBG%2BH1CLBIjoJ5IFjdOCW0KgIgIqK9tUCkPy4GVl3AlIuKGLoByg3RcOzvSBY3iuFF9ygq7QII8v%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARABGgwxMTI2NTg5OTY1NDEiDLshY3q1zF69flK4eyrBAiUEu03r5GQ1NjqZaKhQJW%2F7iukjEtxFUHqljs%2FsBU5vKeXEySiTqG9CZtMqTeMe5mtnyOv4nBmkrTDVHlYqdkRGEEPbz0TGlzdKN4%2Fxwo%2Bz6Dh6wxyO81geQQ7JRNt6jI%2BLcbCdj7YNKlPsCGndHkDNPetet2%2FONLSDlD4vZlyLrI1P42808C%2FbkuI8wSc07w39K2CzUIRWc8casPAiU0m%2FbyaODBW1gGtc1pt4uToNtdm0dCJ7nsfedTvT4l3U0g65zgTBZV%2BDxEawpktkNfi0NRFMxFbTvz8NGh%2FHidGUo%2FX5obHR3dkbwzlvXTJlR4Tq1xX3qNbrDGFDEtgbGFV6ZbMhMMCN4JWcobHBsi0szrrIk34DVxecMnvBVseWGpHuCsmeq42I1p0Kq08ynyLIfMRbNtolb9J5AXKyBxex0zDFhIOVBjqzAgUp0%2BKJ9n52TgWwWaSCZ%2BnTNU9ibRN3tsiIyIFn57UkQC0iZFJaXL0TJ0YCfqCoi3xlTG2%2FMYFW3CJbQgQETqUAgSvurF%2Fd8MHRO9%2B5o16hF0ywEze2JwqZ3ERCpY%2FBuYVzUFcnfYBTt71OQEWB9KWb3zht1QyXdhFbqYJpOw40Jt0tkYCFXRgWO1cvgCf4wtlCmzcrDPZ0q8qxbiRLRVwhUiSCrZAbMJnPgKM%2BDyeluJmFs58hTAtauxpCkAZ5kWiPG1OUOhRIH0%2FsubcnwOPI0qIrgch3cjDK9r9vYtA2thr1ixgK17PoE1jD269KE5yOrPSXAJrKJoOwgO%2FgSeGTesj%2BmujT%2FWBCA0Z%2BaIO8VE%2Ba11tX79S5oAyHgmYa9ZRKq3cyhfJiTAdx0euCRrYcmb8%3D&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20220608T170509Z&X-Amz-SignedHeaders=host&X-Amz-Expires=43200&X-Amz-Credential=ASIARUOX73U6RQ45L4BT%2F20220608%2Feu-central-1%2Fs3%2Faws4_request&X-Amz-Signature=5a178b6711015031c9e930a47692475a8d64a86cf02a858510dbee2555ac52f3
        
      - name: Build Docker Image
        run: docker build -t franklyapp:latest .
      - name: Push and Deploy
        run: |
          service_name=${{ env.AWS_LIGHTSAIL_SERVICE_NAME }}
          aws lightsail push-container-image \
            --region ${{ env.AWS_REGION }} \
            --service-name ${service_name} \
            --label ${service_name} \
            --image ${service_name}:latest

          aws lightsail create-container-service-deployment --service-name franklyapp \
            --containers file://AWS/deploymentconfig.json \
            --public-endpoint file://AWS/publicendpoint.json
